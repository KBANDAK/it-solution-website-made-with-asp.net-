@{
    ViewBag.Title = "Verification";
    var email = ViewBag.Email as string ?? "";
    var message = ViewBag.Message as string ?? "";
}

<div class="verify-container">
    <div class="verify-card">
        <h2>🚀 Verify Your Email</h2>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="verify-message success">
                @message
            </div>
        }

        <p class="verify-instruction">
            We’ve sent a confirmation link to:
            <strong>@email</strong><br />
            Please check your inbox (and spam folder) to activate your account.
        </p>

        <div class="spinner" id="spinner"></div>

        <p class="verify-note">
            This page will automatically redirect once you confirm your email.
            <br />
            Didn't receive an email? <a href="@Url.Action("ResendConfirmation", "Account", new { email = email })">Resend confirmation email</a>.
        </p>
    </div>
</div>

@section Scripts {
    <script>
        // Updated JavaScript to handle both query parameters AND fragments
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return Object.fromEntries(params);
        }

        function getFragmentParams() {
            const fragment = window.location.hash.substring(1);
            const params = new URLSearchParams(fragment);
            return Object.fromEntries(params);
        }


        // Poll server to check if user has verified their email
        async function checkVerificationStatus() {
            try {
                const email = '@HttpUtility.JavaScriptStringEncode(email)';
                console.log("Polling CheckVerificationStatus with email:", email);
                const response = await fetch('/Account/CheckVerificationStatus?email=' + encodeURIComponent(email), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                console.log("CheckVerificationStatus response:", data);
                if (data.isVerified) {
                    document.getElementById("spinner").style.display = "none";
                    sessionStorage.removeItem("verification_query");
                    sessionStorage.removeItem("verification_processed");
                    window.location.href = '@Url.Action("Index", "Home")';
                } else if (data.error) {
                    document.getElementById("spinner").style.display = "none";
                    const messageDiv = document.querySelector(".verify-message");
                    messageDiv.textContent = data.error;
                    messageDiv.classList.add("error");
                }
            } catch (error) {
                console.error('Error checking verification status:', error);
                document.getElementById("spinner").style.display = "none";
                const messageDiv = document.querySelector(".verify-message");
                messageDiv.textContent = "An error occurred while checking verification status.";
                messageDiv.classList.add("error");
            }
        }

        // Poll every 5 seconds if email is present
        let pollingInterval;
        if ('@email' !== '') {
            pollingInterval = setInterval(checkVerificationStatus, 5000);
        }

        // Stop polling when the page is unloaded
        window.addEventListener('unload', () => {
            clearInterval(pollingInterval);
        });
    </script>
}

@section Styles {
<style>
        

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .verify-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 90vh;
            padding: 20px;
        }

        .verify-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            padding: 40px;
            max-width: 500px;
            text-align: center;
            transition: var(--transition);
        }

        .verify-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--hover-shadow);
        }

        .verify-card h2 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .verify-message {
            background: var(--primary-glow);
            color: var(--text-bright);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .verify-message.error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff5555;
        }

        .verify-instruction {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .verify-note {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 30px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-dim);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .spinner.hidden {
            display: none;
        }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
</style>
}