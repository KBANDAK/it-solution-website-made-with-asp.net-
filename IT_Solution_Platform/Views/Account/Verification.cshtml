@{
    ViewBag.Title = "Verification";
    var email = ViewBag.Email as string ?? "";
    var message = ViewBag.Message as string ?? "";
}

<div class="verify-container">
    <div class="verify-card">
        <h2>🚀 Verify Your Email</h2>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="verify-message success">
                @message
            </div>
        }

        <p class="verify-instruction">
            We’ve sent a confirmation link to:
            <strong>@email</strong><br />
            Please check your inbox (and spam folder) to activate your account.
        </p>

        <div class="spinner" id="spinner"></div>

        <p class="verify-note">
            This page will automatically redirect once you confirm your email.
            <br />
            Didn't receive an email? <a href="@Url.Action("ResendConfirmation", "Account", new { email = email })">Resend confirmation email</a>.
        </p>
    </div>
</div>

@section Scripts {
    <script>
        // Function to parse URL fragment parameters
        function getFragmentParams() {
            const fragment = window.location.hash.substring(1); // Remove '#'
            const params = new URLSearchParams(fragment);
            return Object.fromEntries(params);
        }

        // Prevent infinite redirects by checking if verification is already processed
        if (!sessionStorage.getItem("verification_processed")) {
            const fragmentParams = getFragmentParams();
            if (fragmentParams.access_token && fragmentParams.type) {
                // Handle successful verification
                const queryString = `access_token=${encodeURIComponent(fragmentParams.access_token)}&type=${encodeURIComponent(fragmentParams.type)}`;
                sessionStorage.setItem("verification_query", queryString);
                sessionStorage.setItem("verification_processed", "true");
                window.location.href = `/Account/verify?${queryString}`;
            } else if (fragmentParams.error && fragmentParams.error_code && fragmentParams.error_description) {
                // Handle error case
                const queryString = `error=${encodeURIComponent(fragmentParams.error)}&error_code=${encodeURIComponent(fragmentParams.error_code)}&error_description=${encodeURIComponent(fragmentParams.error_description)}`;
                sessionStorage.setItem("verification_query", queryString);
                sessionStorage.setItem("verification_processed", "true");
                window.location.href = `/Account/verify?${queryString}`;
            }
        }

        // Poll server to check if user has verified their email
        async function checkVerificationStatus() {
            try {
                const response = await fetch('/Account/CheckVerificationStatus?email=@HttpUtility.JavaScriptStringEncode(email)', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.isVerified) {
                    // Stop polling and redirect to dashboard
                    document.getElementById("spinner").style.display = "none";
                    sessionStorage.removeItem("verification_query");
                    sessionStorage.removeItem("verification_processed");
                    window.location.href = '@Url.Action("Dashboard", "Home")';
                } else if (data.error) {
                    // Stop polling and show error
                    document.getElementById("spinner").style.display = "none";
                    const messageDiv = document.querySelector(".verify-message");
                    messageDiv.textContent = data.error;
                    messageDiv.classList.add("error");
                }
            } catch (error) {
                console.error('Error checking verification status:', error);
                document.getElementById("spinner").style.display = "none";
                const messageDiv = document.querySelector(".verify-message");
                messageDiv.textContent = "An error occurred while checking verification status.";
                messageDiv.classList.add("error");
            }
        }

        // Poll every 5 seconds if email is present
        let pollingInterval;
        if ('@email' !== '') {
            pollingInterval = setInterval(checkVerificationStatus, 5000);
        }

        // Stop polling when the page is unloaded
        window.addEventListener('unload', () => {
            clearInterval(pollingInterval);
        });
    </script>
}


@@section Styles {
<style>
        :root {
            --primary-color: #00e5ff;
            --primary-dim: #00bbff;
            --accent-color: #ff00e5;
            --dark-bg: #080c14;
            --card-bg: #0d121d;
            --card-hover: #111625;
            --text-bright: rgba(255, 255, 255, 0.95);
            --text-primary: rgba(255, 255, 255, 0.85);
            --text-secondary: rgba(255, 255, 255, 0.65);
            --border-light: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(0, 229, 255, 0.3);
            --glass-bg: rgba(13, 18, 29, 0.7);
            --primary-glow: rgba(0, 229, 255, 0.2);
            --accent-glow: rgba(255, 0, 229, 0.15);
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.35);
            --transition-fast: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-long: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .verify-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 90vh;
            padding: 20px;
        }

        .verify-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            padding: 40px;
            max-width: 500px;
            text-align: center;
            transition: var(--transition);
        }

        .verify-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--hover-shadow);
        }

        .verify-card h2 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .verify-message {
            background: var(--primary-glow);
            color: var(--text-bright);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .verify-message.error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff5555;
        }

        .verify-instruction {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .verify-note {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 30px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-dim);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .spinner.hidden {
            display: none;
        }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
</style>
}