@model IT_Solution_Platform.Models.ProfileViewModel
@{
    ViewBag.Title = "Profile";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .profile-container {
            min-height: calc(100vh - 120px);
            background: linear-gradient(135deg, var(--dark-bg) 0%, #0a0f1a 50%, var(--dark-bg) 100%);
            padding: 2rem 1rem;
            position: relative;
            overflow: hidden;
        }

            .profile-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at 20% 80%, var(--primary-glow) 0%, transparent 50%), radial-gradient(circle at 80% 20%, var(--accent-glow) 0%, transparent 50%);
                pointer-events: none;
                z-index: 1;
            }

        .profile-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideInDown 0.8s ease-out;
        }

        .profile-title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 30px var(--primary-glow);
        }

        .profile-subtitle {
            color: var(--text-secondary);
            font-size: 1.2rem;
            font-weight: 300;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @@media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        .profile-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

            .profile-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
                transform: scaleX(0);
                transition: var(--transition);
            }

            .profile-card:hover {
                transform: translateY(-5px);
                box-shadow: var(--hover-shadow);
                border-color: var(--border-hover);
            }

                .profile-card:hover::before {
                    transform: scaleX(1);
                }

        .avatar-section {
            text-align: center;
            animation: slideInLeft 0.8s ease-out 0.2s both;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .avatar {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: 700;
            color: var(--dark-bg);
            box-shadow: 0 0 40px var(--primary-glow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

            .avatar::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
                transform: rotate(45deg);
                animation: shimmer 3s infinite;
            }

        @@keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            50% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }

            100% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
        }

        .user-name {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
        }

        .user-role {
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            background: rgba(0, 229, 255, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            display: inline-block;
        }

        .info-section {
            animation: slideInRight 0.8s ease-out 0.4s both;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            position: relative;
        }

            .section-title::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                width: 50px;
                height: 2px;
                background: var(--accent-color);
            }

        .info-grid {
            display: grid;
            gap: 1.5rem;
        }

        .info-item {
            background: var(--input-bg);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.25rem;
            transition: var(--transition);
            position: relative;
        }

            .info-item:hover {
                border-color: var(--border-hover);
                background: var(--card-hover);
            }

        .info-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-value {
            color: var(--text-bright);
            font-size: 1.1rem;
            font-weight: 400;
            word-break: break-word;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-inactive {
            background: rgba(255, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        .security-section {
            grid-column: 1 / -1;
            animation: slideInUp 0.8s ease-out 0.6s both;
        }

        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .security-item {
            background: var(--input-bg);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

            .security-item:hover {
                border-color: var(--border-hover);
                transform: translateY(-2px);
            }

        .security-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .security-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
        }

        .security-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .edit-button, .save-button, .cancel-button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dim));
            color: var(--dark-bg);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 5px 15px var(--primary-glow);
            margin: 0.5rem;
        }

            .edit-button:hover, .save-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px var(--primary-glow);
                background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            }

        .cancel-button {
            background: linear-gradient(135deg, var(--error-color), #ff4444);
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
        }

            .cancel-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(255, 68, 68, 0.5);
            }

        .edit-input {
            background: var(--input-bg);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-bright);
            font-size: 1.1rem;
            width: 100%;
            transition: var(--transition);
        }

            .edit-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.2);
            }

        .edit-mode {
            display: none;
        }

            .edit-mode.active {
                display: block;
            }

        .view-mode.editing {
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }

            .message.success {
                background: rgba(0, 255, 136, 0.1);
                color: var(--success-color);
                border: 1px solid var(--success-color);
            }

            .message.error {
                background: rgba(255, 68, 68, 0.1);
                color: var(--error-color);
                border: 1px solid var(--error-color);
            }

            /* Password Reset Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @@keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: var(--text-secondary);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close:hover {
            color: var(--text-bright);
        }

        .password-form-field {
            margin-bottom: 1.5rem;
        }

        .password-form-field label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .password-input {
            background: var(--input-bg);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-bright);
            font-size: 1rem;
            width: 100%;
            transition: var(--transition);
        }

        .password-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.2);
        }

        .password-requirements {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .contact-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .contact-link:hover {
            color: var(--primary-light);
            text-decoration: underline;
        }

        @@keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @@keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @@keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
}

<div class="profile-container">
    <div class="profile-content">
        <div class="profile-header">
            <h1 class="profile-title">User Profile</h1>
            <p class="profile-subtitle">Manage your account information and preferences</p>
        </div>

        <!--Message container for success/error messages -->
        <div id="messageContainer"></div>

        <div class="profile-grid">
            <!-- Avatar Section -->
            <div class="profile-card avatar-section">
                <div class="avatar-container">
                    <div class="avatar">
                        <span id="user-initials">@(string.IsNullOrEmpty(Model.FirstName) ? "--" : Model.FirstName[0].ToString().ToUpper() + (string.IsNullOrEmpty(Model.LastName) ? "" : Model.LastName[0].ToString().ToUpper()))</span>
                    </div>
                </div>
                <div class="user-name" id="user-name">@(Model.FirstName + " " + Model.LastName)</div>
                <div class="user-role">@(Model.RoleName ?? "None")</div>
                <div id="edit-buttons">
                    <button class="edit-button" onclick="toggleEditMode()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>

                <div id="save-buttons" style="display: none;">
                    <button class="save-button" onclick="saveProfile()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button class="cancel-button" onclick="cancelEdit()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <!-- Information Section -->
            <div class="profile-card info-section">
                <h2 class="section-title">
                    <i class="fas fa-user"></i> Personal Information
                </h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-envelope"></i> Email Address
                        </div>
                        <div class="info-value">@(Model.Email ?? "N/A")</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-user"></i> First Name
                        </div>
                        <div class="view-mode">
                            <div class="info-value" id="display-firstname">@(Model.FirstName ?? "N/A")</div>
                        </div>
                        <div class="edit-mode">
                            <input type="text" class="edit-input" id="edit-firstname" value="@Model.FirstName" placeholder="Enter first name" />
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-user"></i> Last Name
                        </div>
                        <div class="view-mode">
                            <div class="info-value" id="display-lastname">@(Model.LastName ?? "N/A")</div>
                        </div>
                        <div class="edit-mode">
                            <input type="text" class="edit-input" id="edit-lastname" value="@Model.LastName" placeholder="Enter last name" />
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-phone"></i> Phone Number
                        </div>
                        <div class="view-mode">
                            <div class="info-value" id="display-phone">@(Model.PhoneNumber ?? "N/A")</div>
                        </div>
                        <div class="edit-mode">
                            <input type="tel" class="edit-input" id="edit-phone" value="@Model.PhoneNumber" placeholder="Enter phone number" />
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-calendar"></i> Member Since
                        </div>
                        <div class="info-value">@Model.CreatedAt.ToString()</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-toggle-on"></i> Account Status
                        </div>
                        <div class="info-value">
                            <span class="status-indicator @(Model.IsActive ? "status-active" : "status-inactive")">
                                <span class="status-dot"></span>
                                @(Model.IsActive ? "Active" : "Inactive")
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Section -->
        <div class="profile-card security-section">
            <h2 class="section-title">
                <i class="fas fa-shield-alt"></i> Security & Authentication
            </h2>
            <div class="security-grid">
                <div class="security-item clickable" onclick="openPasswordModal()">
                    <div class="security-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="security-title">Change Password</div>
                    <div class="security-desc">Update your account password securely</div>
                </div>
                <div class="security-item">
                    <div class="security-icon">
                        <i class="fa-solid fa-envelope"></i>
                    </div>
                    <div class="security-title">Email Verification</div>
                    <div class="security-desc">Your email address has been verified and is secure</div>
                </div>
                <div class="security-item">
                    <div class="security-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="security-title">Last Login</div>
                    <div class="security-desc">Session information available</div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Password Reset Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePasswordModal()">&times;</span>
        <div class="modal-header">
            <h2 class="modal-title">Change Password</h2>
            <p class="modal-subtitle">Enter your current password and choose a new one</p>
        </div>

        <form id="passwordForm">
            <div class="password-form-field">
                <label for="currentPassword">Current Password</label>
                <input type="password" class="password-input" id="currentPassword" placeholder="Enter your current password" required />
                <div class="password-requirements">
                    <small>Don't remember your current password? <a href="#" class="contact-link" onclick="redirectToContact()">Contact Support</a></small>
                </div>
            </div>

            <div class="password-form-field">
                <label for="newPassword">New Password</label>
                <input type="password" class="password-input" id="newPassword" placeholder="Enter your new password" required />
                <div class="password-requirements">
                    <small>Password must be at least 8 characters long with uppercase, lowercase, numbers, and special characters.</small>
                </div>
            </div>

            <div class="password-form-field">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" class="password-input" id="confirmPassword" placeholder="Confirm your new password" required />
            </div>

            <div class="modal-buttons">
                <button type="submit" class="edit-button">
                    <i class="fas fa-save"></i> Update Password
                </button>
                <button type="button" class="cancel-button" onclick="closePasswordModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let isEditMode = false;
        let originalValues = {};

        function toggleEditMode() {
            isEditMode = true;

            // Store original values
            originalValues = {
                firstName: document.getElementById('edit-firstname').value,
                lastName: document.getElementById('edit-lastname').value,
                phoneNumber: document.getElementById('edit-phone').value
            };

            // Show edit mode
            document.querySelectorAll('.edit-mode').forEach(el => el.classList.add('active'));
            document.querySelectorAll('.view-mode').forEach(el => el.classList.add('editing'));

            // Toggle buttons
            document.getElementById('edit-buttons').style.display = 'none';
            document.getElementById('save-buttons').style.display = 'block';

            // Clear any existing messages
            clearMessages();
        }

        function cancelEdit() {
            isEditMode = false;

            // Restore original values
            document.getElementById('edit-firstname').value = originalValues.firstName || '';
            document.getElementById('edit-lastname').value = originalValues.lastName || '';
            document.getElementById('edit-phone').value = originalValues.phoneNumber || '';

            // Hide edit mode
            document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view-mode').forEach(el => el.classList.remove('editing'));

            // Toggle buttons
            document.getElementById('edit-buttons').style.display = 'block';
            document.getElementById('save-buttons').style.display = 'none';

            // Clear any existing messages
            clearMessages();
        }

        async function saveProfile() {
            const firstName = document.getElementById('edit-firstname').value.trim();
            const lastName = document.getElementById('edit-lastname').value.trim();
            const phoneNumber = document.getElementById('edit-phone').value.trim();

            // Basic validation
            if (!firstName) {
                showMessage('First name is required', 'error');
                return;
            }

            if (!lastName) {
                showMessage('Last name is required', 'error');
                return;
            }

            // Show loading state
            setLoadingState(true);

            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value ||
                             document.querySelector('meta[name="__RequestVerificationToken"]')?.content;

                const formData = new FormData();
                formData.append('firstName', firstName);
                formData.append('lastName', lastName);
                formData.append('phoneNumber', phoneNumber);

                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch('@Url.Action("UpdateProfileAsync", "Account")', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Update display values
                    document.getElementById('display-firstname').textContent = firstName;
                    document.getElementById('display-lastname').textContent = lastName;
                    document.getElementById('display-phone').textContent = phoneNumber || 'N/A';
                    document.getElementById('user-name').textContent = `${firstName} ${lastName}`;

                    // Update avatar initials
                    const initials = (firstName[0] || '') + (lastName[0] || '');
                    document.getElementById('user-initials').textContent = initials.toUpperCase();

                    // Exit edit mode
                    isEditMode = false;
                    document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.view-mode').forEach(el => el.classList.remove('editing'));
                    document.getElementById('edit-buttons').style.display = 'block';
                    document.getElementById('save-buttons').style.display = 'none';

                    showMessage(result.message || 'Profile updated successfully!', 'success');
                } else {
                    showMessage(result.message || 'Failed to update profile', 'error');
                }

            } catch (error) {
                console.error('Error updating profile:', error);
                showMessage('An error occurred while updating your profile. Please try again.', 'error');
            } finally {
                setLoadingState(false);
            }
        }

        // Password Modal Functions
        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            clearMessages();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.body.style.overflow = 'auto';

            // Clear form
            document.getElementById('passwordForm').reset();
            clearMessages();
        }

        function redirectToContact() {
            window.location.href = '@Url.Action("Contact", "Home")';
        }


        // Password form validation and submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('All password fields are required', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('New passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showMessage('New password must be at least 8 characters long', 'error');
                return;
            }

            if (currentPassword === newPassword) {
                showMessage('New password must be different from current password', 'error');
                return;
            }

            // Password strength validation
            const hasUpper = /[A-Z]/.test(newPassword);
            const hasLower = /[a-z]/.test(newPassword);
            const hasNumber = /\d/.test(newPassword);
            const hasSpecial = /[!@@#$%^&*(),.?":{}|<>]/.test(newPassword);

            if (!(hasUpper && hasLower && hasNumber && hasSpecial)) {
                showMessage('New password must include uppercase, lowercase, numbers, and special characters', 'error');
                return;
            }

            setLoadingState(true);

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value ||
                             document.querySelector('meta[name="__RequestVerificationToken"]')?.content;

                const formData = new FormData();
                formData.append('currentPassword', currentPassword);
                formData.append('newPassword', newPassword);
                formData.append('confirmPassword', confirmPassword);

                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch('@Url.Action("ChangePassword", "Profile")', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message || 'Password updated successfully!', 'success');
                    setTimeout(() => {
                        closePasswordModal();
                    }, 2000);
                } else {
                    showMessage(result.message || 'Failed to update password', 'error');
                }

            } catch (error) {
                console.error('Error updating password:', error);
                showMessage('An error occurred while updating your password. Please try again.', 'error');
            } finally {
                setLoadingState(false);
            }
        });


        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('passwordModal');
            if (event.target === modal) {
                closePasswordModal();
            }
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;

            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    clearMessages();
                }, 5000);
            }
        }

        function clearMessages() {
            document.getElementById('messageContainer').innerHTML = '';
        }

        function setLoadingState(loading) {
            const container = document.querySelector('.profile-container');
            if (loading) {
                container.classList.add('loading');
            } else {
                container.classList.remove('loading');
            }
        }

        // Remove loading states (not needed with server-side rendering)
        document.querySelectorAll('.loading').forEach(element => {
            element.classList.remove('loading');
        });
    </script>
}

@Html.AntiForgeryToken()
